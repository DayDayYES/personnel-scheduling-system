# ğŸ“Š è°ƒåº¦ç»“æœæ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆè¯´æ˜

## ğŸ¯ ç»Ÿä¸€æ•°æ®æ ¼å¼

### æ ‡å‡†æ•°æ®æ ¼å¼ï¼ˆ10ä¸ªå­—æ®µï¼‰

```json
{
  "id": 1,
  "name": "1-æ­æ¶å­",
  "workpoint_id": "workpoint_1",
  "workpoint_name": "è®¾å¤‡1",
  "team": "team1",
  "start": 0.0,
  "end": 10.5,
  "duration": 10.5,
  "workers": 5,
  "order": 1
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | æ¥æº |
|------|------|------|------|
| `id` | int | ä»»åŠ¡å”¯ä¸€æ ‡è¯† | ç®—æ³•è¾“å‡º |
| `name` | string | ä»»åŠ¡åç§° | ç®—æ³•è¾“å‡º (`display_name`) |
| `workpoint_id` | string | è®¾å¤‡ID | ç®—æ³•è¾“å‡º |
| `workpoint_name` | string | è®¾å¤‡åç§° | ç®—æ³•è¾“å‡º |
| `team` | string | å›¢é˜ŸID | ç®—æ³•è¾“å‡º |
| `start` | float | å¼€å§‹æ—¶é—´ | ç®—æ³•è¾“å‡º |
| `end` | float | ç»“æŸæ—¶é—´ | ç®—æ³•è¾“å‡º |
| `duration` | float | æŒç»­æ—¶é—´ | è®¡ç®—å¾—å‡º (`end - start`) |
| `workers` | int | åˆ†é…å·¥äººæ•° | ç®—æ³•è¾“å‡º |
| `order` | int | å·¥åºé¡ºåº | ç®—æ³•è¾“å‡º |

---

## ğŸ“¦ æ•°æ®åº“è¡¨ç»“æ„

### æ–°è¡¨ç»“æ„ï¼š`schedule_result_{timestamp}`

```sql
CREATE TABLE `schedule_result_20241027_153045` (
    `task_id` INT PRIMARY KEY COMMENT 'ä»»åŠ¡ID',
    `task_name` VARCHAR(100) NOT NULL COMMENT 'ä»»åŠ¡åç§°',
    `workpoint_id` VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡ID',
    `workpoint_name` VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡åç§°',
    `team` VARCHAR(50) NOT NULL COMMENT 'å›¢é˜ŸID',
    `start_time` DECIMAL(10,2) NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
    `end_time` DECIMAL(10,2) NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
    `duration` DECIMAL(10,2) NOT NULL COMMENT 'æŒç»­æ—¶é—´',
    `workers` INT NOT NULL COMMENT 'åˆ†é…å·¥äººæ•°',
    `process_order` INT COMMENT 'å·¥åºé¡ºåº',
    `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX `idx_workpoint` (`workpoint_id`),
    INDEX `idx_team` (`team`),
    INDEX `idx_start_time` (`start_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci 
COMMENT='ç®—æ³•:DDQN - å®Œå·¥æ—¶é—´:75.50';
```

**ç›¸æ¯”æ—§è¡¨ç»“æ„çš„æ”¹è¿›**ï¼š

| æ”¹è¿›é¡¹ | è¯´æ˜ |
|--------|------|
| âœ… æ–°å¢ `workpoint_id` | æ”¯æŒè®¾å¤‡è§†è§’åˆ†ç»„ |
| âœ… æ–°å¢ `workpoint_name` | è®¾å¤‡åç§°æ˜¾ç¤º |
| âœ… ä¿ç•™ `duration` | æŒç»­æ—¶é—´ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰ |
| âœ… æ–°å¢ `process_order` | å·¥åºé¡ºåº |
| âœ… æ–°å¢ç´¢å¼• | ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ |
| âœ… è¡¨æ³¨é‡Šå­˜å‚¨å…ƒæ•°æ® | è®°å½•ç®—æ³•åç§°å’Œå®Œå·¥æ—¶é—´ |

---

## ğŸ”§ æ–°å¢APIæ–¹æ³•

### 1. `save_schedule_result()` - ä¿å­˜è°ƒåº¦ç»“æœ

**åŠŸèƒ½**: ä¿å­˜è°ƒåº¦ç»“æœåˆ°æ•°æ®åº“ï¼ˆæ¨èä½¿ç”¨ï¼‰

**å‚æ•°**:
```python
schedule_data: list  # è°ƒåº¦ç»“æœåˆ—è¡¨ï¼ˆæ¥è‡ª env.get_schedule()ï¼‰
makespan: float      # å®Œå·¥æ—¶é—´ï¼ˆå¯é€‰ï¼‰
algorithm_name: str  # ç®—æ³•åç§°ï¼ˆå¯é€‰ï¼Œå¦‚ 'DDQN', 'Greedy'ï¼‰
```

**è¿”å›**: 
- `str`: è¡¨åï¼ˆå¦‚æˆåŠŸï¼‰
- `None`: å¦‚æœå¤±è´¥

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from db_connector import DatabaseConnector

# åˆ›å»ºæ•°æ®åº“è¿æ¥
db = DatabaseConnector(
    host="localhost",
    user="root",
    password="123456",
    database="scheduling_system"
)

# ä¿å­˜è°ƒåº¦ç»“æœ
table_name = db.save_schedule_result(
    schedule_data=final_schedule,  # æ¥è‡ª env.get_schedule()
    makespan=75.5,
    algorithm_name='DDQN'
)

if table_name:
    print(f"âœ… æˆåŠŸä¿å­˜åˆ°è¡¨: {table_name}")
else:
    print("âŒ ä¿å­˜å¤±è´¥")

db.close()
```

---

### 2. `load_schedule_result()` - è¯»å–è°ƒåº¦ç»“æœ

**åŠŸèƒ½**: ä»æ•°æ®åº“è¯»å–è°ƒåº¦ç»“æœ

**å‚æ•°**:
```python
table_name: str  # è¡¨åï¼Œå¦‚æœä¸ºNoneåˆ™è¯»å–æœ€æ–°çš„
```

**è¿”å›**:
```python
{
    'schedule_data': [...],     # è°ƒåº¦ä»»åŠ¡åˆ—è¡¨
    'makespan': 75.5,           # å®Œå·¥æ—¶é—´
    'algorithm': 'DDQN',        # ç®—æ³•åç§°
    'table_name': 'schedule_result_20241027_153045',
    'task_count': 24            # ä»»åŠ¡æ•°é‡
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from db_connector import DatabaseConnector

db = DatabaseConnector()

# è¯»å–æœ€æ–°çš„è°ƒåº¦ç»“æœ
result = db.load_schedule_result()

if result:
    print(f"âœ… è¯»å–æˆåŠŸ: {result['task_count']} ä¸ªä»»åŠ¡")
    print(f"   å®Œå·¥æ—¶é—´: {result['makespan']}")
    print(f"   ç®—æ³•: {result['algorithm']}")
    
    # ä½¿ç”¨è°ƒåº¦æ•°æ®
    schedule_data = result['schedule_data']
    for task in schedule_data:
        print(f"ä»»åŠ¡ {task['id']}: {task['name']}")
else:
    print("âŒ è¯»å–å¤±è´¥")

db.close()
```

**è¯»å–æŒ‡å®šè¡¨**:
```python
result = db.load_schedule_result(table_name='schedule_result_20241027_153045')
```

---

### 3. `list_schedule_results()` - åˆ—å‡ºæ‰€æœ‰è°ƒåº¦ç»“æœ

**åŠŸèƒ½**: åˆ—å‡ºæ•°æ®åº“ä¸­çš„æ‰€æœ‰è°ƒåº¦ç»“æœè¡¨

**å‚æ•°**:
```python
limit: int  # è¿”å›çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤10
```

**è¿”å›**:
```python
[
    {
        'table_name': 'schedule_result_20241027_153045',
        'comment': 'ç®—æ³•:DDQN - å®Œå·¥æ—¶é—´:75.50',
        'created_at': '2024-10-27 15:30:45',
        'task_count': 24
    },
    {
        'table_name': 'schedule_result_20241027_120030',
        'comment': 'ç®—æ³•:Greedy - å®Œå·¥æ—¶é—´:80.20',
        'created_at': '2024-10-27 12:00:30',
        'task_count': 24
    },
    ...
]
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
from db_connector import DatabaseConnector

db = DatabaseConnector()

# åˆ—å‡ºæœ€è¿‘10ä¸ªè°ƒåº¦ç»“æœ
results = db.list_schedule_results(limit=10)

if results:
    print(f"ğŸ“‹ æ‰¾åˆ° {len(results)} ä¸ªè°ƒåº¦ç»“æœ:")
    for r in results:
        print(f"  - {r['table_name']}: {r['comment']} ({r['task_count']} ä»»åŠ¡)")
else:
    print("â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°è°ƒåº¦ç»“æœ")

db.close()
```

---

## ğŸ”„ é›†æˆåˆ°è°ƒåº¦ç®—æ³•

### æ–¹æ¡ˆA: åœ¨ `main.py` ä¸­ä¿å­˜

```python
# DDQN/main.py

def RUN(workpoints_data, save_processes_to_db=True):
    """å¤šå·¥ä½œç‚¹è°ƒåº¦ç®—æ³•ä¸»å‡½æ•°"""
    
    # ... è¿è¡Œç®—æ³• ...
    
    # è·å–æœ€ä¼˜ç»“æœ
    final_schedule = current_best['schedule']
    final_makespan = current_best['makespan']
    best_algorithm = current_best['algorithm']
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    if save_processes_to_db:
        from db_connector import DatabaseConnector
        db = DatabaseConnector()
        
        table_name = db.save_schedule_result(
            schedule_data=final_schedule,
            makespan=final_makespan,
            algorithm_name=best_algorithm
        )
        
        if table_name:
            print(f"âœ… è°ƒåº¦ç»“æœå·²ä¿å­˜åˆ°æ•°æ®åº“: {table_name}")
        
        db.close()
    
    # ç”Ÿæˆå¯è§†åŒ–
    record, process_fig, workpoint_fig, team_fig = save_gantt_charts(
        final_schedule, final_makespan, env
    )
    
    return final_schedule, final_makespan, process_fig, workpoint_fig, team_fig
```

---

### æ–¹æ¡ˆB: åœ¨ `Flask.py` ä¸­ä¿å­˜

```python
# DDQN/Flask.py

@app.route('/run_ddqn', methods=['POST'])
def run_algorithm():
    """è¿è¡ŒDDQNè°ƒåº¦ç®—æ³•"""
    try:
        # è¿è¡Œç®—æ³•
        result = RUN(workpoints_data, save_processes_to_db=False)
        
        if result is None:
            return jsonify({"error": "ç®—æ³•è¿è¡Œå¤±è´¥"}), 500
        
        schedule, makespan, process_fig, workpoint_fig, team_fig = result
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        from db_connector import DatabaseConnector
        db = DatabaseConnector()
        
        table_name = db.save_schedule_result(
            schedule_data=schedule,
            makespan=makespan,
            algorithm_name='DDQN'
        )
        
        db.close()
        
        # è½¬æ¢å›¾ç‰‡ä¸ºbase64
        images = {
            'process_gantt': fig_to_base64(process_fig),
            'workpoint_gantt': fig_to_base64(workpoint_fig),
            'team_gantt': fig_to_base64(team_fig)
        }
        
        return jsonify({
            "schedule_data": schedule,  # è°ƒåº¦æ•°æ®
            "makespan": float(makespan),
            "table_name": table_name,   # æ•°æ®åº“è¡¨å
            "gantt_charts": images,
            "chart_info": {...}
        })
        
    except Exception as e:
        return jsonify({"error": str(e)}), 500
```

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
è°ƒåº¦ç®—æ³•è¿è¡Œ (scheduling_environment.py)
    â†“
ç”Ÿæˆ schedule åˆ—è¡¨ (env.get_schedule())
    â†“ {id, name, workpoint_id, workpoint_name, team, start, end, workers, order}
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                        â”‚
â†“                                        â†“
ä¿å­˜åˆ°æ•°æ®åº“                        è¿”å›ç»™Flask API
(db.save_schedule_result)              (Flask.py)
    â†“                                    â†“
schedule_result_{timestamp}          JSON è¿”å›
    â†“                                    â†“
å¯æŸ¥è¯¢å†å²ç»“æœ                      å‰ç«¯æ¸²æŸ“
(db.load_schedule_result)          (DHTMLX Gantt)
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: ä¿å­˜å’Œè¯»å–è°ƒåº¦ç»“æœ

```python
# test_db_storage.py

from db_connector import DatabaseConnector

# æ¨¡æ‹Ÿè°ƒåº¦ç»“æœæ•°æ®
test_schedule = [
    {
        'id': 1,
        'name': '1-æ­æ¶å­',
        'workpoint_id': 'workpoint_1',
        'workpoint_name': 'è®¾å¤‡1',
        'team': 'team1',
        'start': 0.0,
        'end': 10.5,
        'workers': 5,
        'order': 1
    },
    {
        'id': 2,
        'name': '1-æ‹†ä¿æ¸©',
        'workpoint_id': 'workpoint_1',
        'workpoint_name': 'è®¾å¤‡1',
        'team': 'team2',
        'start': 10.5,
        'end': 15.3,
        'workers': 8,
        'order': 2
    }
]

# åˆ›å»ºæ•°æ®åº“è¿æ¥
db = DatabaseConnector(database="scheduling_system")

# æµ‹è¯•ä¿å­˜
print("æµ‹è¯•ä¿å­˜è°ƒåº¦ç»“æœ...")
table_name = db.save_schedule_result(
    schedule_data=test_schedule,
    makespan=15.3,
    algorithm_name='TEST'
)

if table_name:
    print(f"âœ… ä¿å­˜æˆåŠŸ: {table_name}")
    
    # æµ‹è¯•è¯»å–
    print("\næµ‹è¯•è¯»å–è°ƒåº¦ç»“æœ...")
    result = db.load_schedule_result(table_name=table_name)
    
    if result:
        print(f"âœ… è¯»å–æˆåŠŸ:")
        print(f"   ä»»åŠ¡æ•°: {result['task_count']}")
        print(f"   å®Œå·¥æ—¶é—´: {result['makespan']}")
        print(f"   ç®—æ³•: {result['algorithm']}")
        print(f"   æ•°æ®å®Œæ•´æ€§: {len(result['schedule_data']) == len(test_schedule)}")
    else:
        print("âŒ è¯»å–å¤±è´¥")
else:
    print("âŒ ä¿å­˜å¤±è´¥")

db.close()
```

---

### æµ‹è¯•2: åˆ—å‡ºå†å²ç»“æœ

```python
from db_connector import DatabaseConnector

db = DatabaseConnector(database="scheduling_system")

# åˆ—å‡ºæ‰€æœ‰è°ƒåº¦ç»“æœ
results = db.list_schedule_results(limit=5)

if results:
    print(f"ğŸ“‹ æœ€è¿‘ {len(results)} ä¸ªè°ƒåº¦ç»“æœ:\n")
    for i, r in enumerate(results, 1):
        print(f"{i}. {r['table_name']}")
        print(f"   æè¿°: {r['comment']}")
        print(f"   ä»»åŠ¡æ•°: {r['task_count']}")
        print(f"   åˆ›å»ºæ—¶é—´: {r['created_at']}\n")
else:
    print("â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°è°ƒåº¦ç»“æœ")

db.close()
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®åº“é…ç½®

ç¡®ä¿æ•°æ®åº“é…ç½®æ­£ç¡®ï¼š

```python
db = DatabaseConnector(
    host="localhost",         # æ•°æ®åº“ä¸»æœº
    user="root",              # ç”¨æˆ·å
    password="123456",        # å¯†ç 
    database="scheduling_system"  # æ•°æ®åº“åï¼ˆéœ€æå‰åˆ›å»ºï¼‰
)
```

### 2. æ•°æ®åº“åˆ›å»º

é¦–æ¬¡ä½¿ç”¨å‰éœ€è¦åˆ›å»ºæ•°æ®åº“ï¼š

```sql
CREATE DATABASE IF NOT EXISTS scheduling_system 
DEFAULT CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### 3. æƒé™è®¾ç½®

ç¡®ä¿MySQLç”¨æˆ·æœ‰åˆ›å»ºè¡¨çš„æƒé™ï¼š

```sql
GRANT CREATE, INSERT, SELECT, DROP ON scheduling_system.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

### 4. æ—§æ–¹æ³•å…¼å®¹æ€§

æ—§çš„ `save_task_schedule()` æ–¹æ³•ä»ç„¶ä¿ç•™ï¼Œä½†å·²æ ‡è®°ä¸ºåºŸå¼ƒã€‚å»ºè®®ä½¿ç”¨æ–°çš„ `save_schedule_result()` æ–¹æ³•ã€‚

### 5. æŒç»­æ—¶é—´è‡ªåŠ¨è®¡ç®—

`duration` å­—æ®µåœ¨ä¿å­˜æ—¶è‡ªåŠ¨è®¡ç®—ï¼ˆ`end - start`ï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ å…¥ã€‚

---

## ğŸ¯ ä¼˜åŠ¿æ€»ç»“

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| âœ… æ•°æ®æ ¼å¼ç»Ÿä¸€ | ç®—æ³•è¾“å‡º = æ•°æ®åº“å­˜å‚¨ = APIè¿”å› = å‰ç«¯éœ€æ±‚ |
| âœ… æ”¯æŒä¸‰ç§è§†è§’ | workpoint_id + team + order å…¨éƒ¨åŒ…å« |
| âœ… å†å²è®°å½•æŸ¥è¯¢ | å¯æŸ¥è¯¢å’Œå¯¹æ¯”ä¸åŒæ—¶é—´çš„è°ƒåº¦ç»“æœ |
| âœ… å…ƒæ•°æ®å­˜å‚¨ | è¡¨æ³¨é‡Šè®°å½•ç®—æ³•åç§°å’Œå®Œå·¥æ—¶é—´ |
| âœ… æ€§èƒ½ä¼˜åŒ– | æ·»åŠ ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ |
| âœ… å‘åå…¼å®¹ | ä¿ç•™æ—§æ–¹æ³•ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ |
| âœ… æŒç»­æ—¶é—´å­—æ®µ | ä¿ç•™ duration å­—æ®µï¼Œæ–¹ä¾¿æŸ¥è¯¢å’Œç»Ÿè®¡ |

---

## ğŸ“ åç»­æ‰©å±•

### å¯èƒ½çš„åŠŸèƒ½æ‰©å±•ï¼š

1. **ç»“æœå¯¹æ¯”åŠŸèƒ½**
   - å¯¹æ¯”ä¸åŒç®—æ³•çš„è°ƒåº¦ç»“æœ
   - å¯¹æ¯”ä¸åŒå‚æ•°çš„ä¼˜åŒ–æ•ˆæœ

2. **ç»Ÿè®¡åˆ†æ**
   - å®Œå·¥æ—¶é—´è¶‹åŠ¿åˆ†æ
   - è®¾å¤‡åˆ©ç”¨ç‡ç»Ÿè®¡
   - å›¢é˜Ÿå·¥ä½œè´Ÿè½½åˆ†æ

3. **ç»“æœç­›é€‰**
   - æŒ‰ç®—æ³•ç­›é€‰
   - æŒ‰å®Œå·¥æ—¶é—´èŒƒå›´ç­›é€‰
   - æŒ‰æ—¥æœŸç­›é€‰

4. **æ•°æ®å¯¼å‡º**
   - å¯¼å‡ºä¸ºExcel
   - å¯¼å‡ºä¸ºCSV
   - å¯¼å‡ºä¸ºJSON

---

**æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆå·²å®Œæˆï¼** âœ…

